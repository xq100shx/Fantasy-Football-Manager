{% extends 'base.html' %}
{% load static %}
{% block title %}Football Team Editor{% endblock %}
{% block content %}
    <link rel="stylesheet" href="{% static 'core/css/team.css' %}">
    <div class="container-fluid">
        <!-- Dropdown to select formation -->
        <div class="text-center mb-3">
            <label for="formationSelect" class="form-label">Select Formation:</label>
            <select class="form-select w-auto mx-auto" id="formationSelect">
                <option value="4-4-2">4-4-2</option>
                <option value="4-3-3">4-3-3</option>
                <option value="3-5-2">3-5-2</option>
                <option value="5-3-2">5-3-2</option>
                <option value="3-4-1-2">3-4-1-2</option>
            </select>
        </div>

        <!-- Responsive Football Pitch -->
        <div class="pitch mx-auto" id="pitch"></div>

        <!-- Modal for selecting players -->
        <div class="modal" id="playerModal">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Select a Player</h5>
                        <button type="button" class="btn-close" onclick="closeModal()"></button>
                    </div>
                    <div class="modal-body">
                        <input type="text" class="form-control mb-3" id="playerSearch"
                               placeholder="Search for a player...">
                        <ul id="playerList" class="list-group"></ul>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const pitch = document.getElementById("pitch");
        const playerModal = document.getElementById("playerModal");
        const playerSearch = document.getElementById("playerSearch");
        const playerList = document.getElementById("playerList");
        const formationSelect = document.getElementById("formationSelect");
        let selectedCard = null;

        // Placeholder for players fetched from the database
        {#const players = [#}
        {#  { id: 1, name: "John Doe", photo: "{% static 'core/img/phplayer.jpg' %}" , club: "{% static 'core/img/phclub.png' %}"},#}
        {#  { id: 2, name: "Jane Smith", photo: "{% static 'core/img/phplayer.jpg' %}", club: "{% static 'core/img/phclub.png' %}"},#}
        {#  { id: 3, name: "Mike Johnson", photo: "{% static 'core/img/phplayer.jpg' %}", club: "{% static 'core/img/phclub.png' %}"},#}
        {#];#}
        const players = {{ players | safe }};

        // Function to generate formation dynamically
        function generateFormation(formationRows) {
            //add the goalkeeper to the formation rows
            formationRows.unshift(1);
            const formation = [];
            const rowHeight = 120 / (formationRows.length + 1); // Divide pitch height evenly
            formationRows.reverse().forEach((playersInRow, rowIndex) => {
                const top = rowHeight * (rowIndex + 1)-10; // Calculate vertical placement
                const colWidth = 100 / (playersInRow + 1); // Distribute players evenly horizontally
                for (let i = 1; i <= playersInRow; i++) {
                    formation.push({
                        top: `${top}%`,
                        left: `${colWidth * i}%`,
                    });
                }
            });

            return formation;
        }

        // Function to create a player card
        function createPlayerCard(name = "", teamName = "", playerPosition, position = {}) {
            const card = document.createElement("div");
            card.classList.add("player-card");
            card.style.top = position.top;
            card.style.left = position.left;
            card.innerHTML = `
            {#<img src="{% static 'core/img/placeholder150x150.png' %}" alt="Player">#}
            <div class="player-info">
            {#<p style="background-image: url('${clubLogoUrl}')">${name || "Empty"}</p>#}
            <p>${playerPosition || "Empty"}</p>
            <p>${name || "Empty"}</p>
            <p>${teamName || "Empty"}</p>
            </div>
          `;
            card.addEventListener("click", () => {
                selectedCard = card;
                openModal();
            });
            return card;
        }

        // Function to render formation on the pitch
        function renderFormation(formation) {
            pitch.innerHTML = "";
            formation.forEach((pos) => {
                const playerCard = createPlayerCard("", "", "", pos);
                pitch.appendChild(playerCard);
            });
        }

        // Open modal for player selection
        function openModal() {
            playerModal.style.display = "block";
            playerSearch.value = "";
            renderPlayerList(players);
        }

        // Close modal
        function closeModal() {
            playerModal.style.display = "none";
        }

        // Render player list in the modal
        function renderPlayerList(playerListData) {
            playerList.innerHTML = "";
            playerListData.forEach((player) => {
                const li = document.createElement("li");
                li.classList.add("list-group-item");
                li.textContent = player.name;
                li.addEventListener("click", () => selectPlayer(player));
                playerList.appendChild(li);
            });
        }

        // Select a player and update the card
        function selectPlayer(player) {
            if (selectedCard) {
                selectedCard.querySelector(".player-info").innerHTML = `
                  <p>${player.position}</p>
                  <p>${player.name}</p>
                  <p>${player.team}</p>
                `;
                closeModal();
            }
        }

        playerSearch.addEventListener('input', () => {
            const searchValue = playerSearch.value.toLowerCase();
            const filteredPlayers = players.filter(player =>
                player.name.toLowerCase().includes(searchValue)
            );
            renderPlayerList(filteredPlayers);
        });
        // Handle formation selection change
        formationSelect.addEventListener("change", () => {
            const selectedFormation = formationSelect.value;
            let formation;

            switch (selectedFormation) {
                case "4-4-2":
                    formation = generateFormation([4, 4, 2]);
                    break;
                case "4-3-3":
                    formation = generateFormation([4, 3, 3]);
                    break;
                case "3-5-2":
                    formation = generateFormation([3, 5, 2]);
                    break;
                case "5-3-2":
                    formation = generateFormation([5, 3, 2]);
                    break;
                case "3-4-1-2":
                    formation = generateFormation([3, 4, 1, 2]);
                    break;
                default:
                    formation = generateFormation([4, 4, 2]);
            }

            renderFormation(formation);
        });

        // Default formation on page load
        const defaultFormation = generateFormation([4, 4, 2]);
        renderFormation(defaultFormation);
    </script>
{% endblock %}